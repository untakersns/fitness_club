@page "/"
@using fitness_club_front.Components.Blocks
@using fitness_club_front.Models
@inject fitness_club_front.Services.TrainingSessionService SessionService

<PageTitle>Главная</PageTitle>

<div class="container">
    <Header/>

    <div class="main-wrapper">
        <div class="content-grid">
            <Sidebar OnFiltersChanged="OnFiltersChangedAsync"/>

            <div class="main-content">
                <ResultsHeader TotalCount="totalCount" PageSize="currentQuery.PageSize" OnPageSizeChanged="OnPageSizeChangedAsync"/>

                <div class="session-grid">
                    @if (isLoading)
                    {
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                        <div class="skeleton-card"></div>
                    }
                    else if (sessions?.Any() != true)
                    {
                        <div class="empty-state">Сессии не найдены.</div>
                    }
                    else
                    {
                        @foreach (var s in sessions!)
                        {
                            <FitnessCard Session="s" />
                        }
                    }
                </div>

                <Pagination PageNumber="currentQuery.PageNumber" PageSize="currentQuery.PageSize" TotalCount="totalCount" OnPageChanged="OnPageChangedAsync" />
            </div>
        </div>
    </div>
</div>

@code {
    private IEnumerable<TrainingSessionDto>? sessions;
    private bool isLoading = true;
    private TrainingSessionQuery currentQuery = new() { PageNumber = 1, PageSize = 12 };
    private int totalCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadSessionsAsync(currentQuery);
    }

    private async Task OnFiltersChangedAsync(TrainingSessionQuery query)
    {
        currentQuery = query ?? new TrainingSessionQuery { PageNumber = 1, PageSize = 12 };
        // ensure page number is valid when filters change
        currentQuery.PageNumber = 1;
        await LoadSessionsAsync(currentQuery);
    }

    private async Task OnPageSizeChangedAsync(int newSize)
    {
        currentQuery.PageSize = newSize;
        currentQuery.PageNumber = 1;
        await LoadSessionsAsync(currentQuery);
    }

    private async Task OnPageChangedAsync(int newPage)
    {
        currentQuery.PageNumber = newPage;
        await LoadSessionsAsync(currentQuery);
    }

    private async Task LoadSessionsAsync(TrainingSessionQuery query)
    {
        isLoading = true;
        try
        {
            var result = await SessionService.GetSessionsAsync(query);
            sessions = result?.Items ?? Enumerable.Empty<TrainingSessionDto>();
            totalCount = result?.TotalCount ?? 0;
            var totalPages = query.PageSize > 0 ? (int)Math.Ceiling(totalCount / (double)query.PageSize) : 1;
            if (query.PageNumber > totalPages && totalPages > 0)
            {
                currentQuery.PageNumber = totalPages;
                var retry = await SessionService.GetSessionsAsync(currentQuery);
                sessions = retry?.Items ?? Enumerable.Empty<TrainingSessionDto>();
            }
        }
        catch
        {
            sessions = Enumerable.Empty<TrainingSessionDto>();
            totalCount = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}